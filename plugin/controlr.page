Menu="Utilities"
Icon="controlr.png"
Title="ControlR"
---
<?php
$sName = "controlr";
$controlr_cfg = parse_plugin_cfg("controlr");
$controlr_service = isset($controlr_cfg['SERVICE']) ? $controlr_cfg['SERVICE'] 	: "disable";
$controlr_port = (isset($controlr_cfg['PORT']) && is_numeric($controlr_cfg['PORT']) && $controlr_cfg['PORT'] > 0 && $controlr_cfg['PORT'] < 65535 ) ? $controlr_cfg['PORT'] : "2378";
$controlr_sport = (isset($controlr_cfg['SPORT']) && is_numeric($controlr_cfg['SPORT']) && $controlr_cfg['SPORT'] > 0 && $controlr_cfg['SPORT'] < 65535 ) ? $controlr_cfg['SPORT'] : "2379";
$controlr_running = shell_exec("pidof controlr | wc -w");
$controlr_version = shell_exec("cat /usr/local/emhttp/plugins/controlr/VERSION");
$controlr_version = ($controlr_running == 1) ?
	"<a style='color:green;' target='_blank' href='http://".$var['NAME'].".local:".$controlr_port."' title='ControlR plugin'><b>Open http Web UI ( v$controlr_version)</b></a><br/>
	<a style='color:green;' target='_blank' href='https://".$var['NAME'].".local:".$controlr_sport."' title='ControlR plugin'><b>Open https Web UI ( v$controlr_version)</b></a>":
	"<b><font style='color:orange;'>ControlR v$controlr_version</font></b>";
?>

<form markdown="1" name="controlr_settings" method="POST" action="/update.php" target="progressFrame">
<input type="hidden" name="#file" value="controlr/controlr.cfg" />
<input type="hidden" id="command" name="#command" value="" />

<p><?=$controlr_version;?></p>

Enable ControlR Server :
: <select id="SERVICE" name="SERVICE" size="1" onChange="checkRUNNING(this.form);">
  <?=mk_option($controlr_service, "disable", "No");?>
  <?=mk_option($controlr_service, "enable", "Yes");?>
  </select>

Port (http):
: <input id="PORT" type="text" class="stopped" name="PORT" maxlength="40" value="<?=$controlr_port;?>" title="port must be 0-65535" placeholder="Default Port is 2378" >

Secure Port (https):
: <input id="SPORT" type="text" class="stopped" name="SPORT" maxlength="40" value="<?=$controlr_sport;?>" title="port must be 0-65535" placeholder="Default Port is 2379" >

<input id="DEFAULT" class="stopped" type="submit" value="Default" onClick="resetDATA(this.form)">
: <input id="btnApply" type="submit" value="Apply" onClick="verifyDATA(this.form)"><input type="button" value="Done" onClick="done()">
</form>

<script type="text/javascript">
$(function(){
	showStatus('<?=$sName;?>');
	checkRUNNING(document.controlr_settings);
});

function resetDATA(form) {
	form.PORT.value = "2378";
	form.SPORT.value = "2379";
}

function checkRUNNING(form) {
	if (<?=$controlr_running;?> == 1)
	{
		$(".stopped").prop("disabled", true);
		form.btnApply.disabled = "disabled";
   }
   else
	$(".stopped").prop("disabled", (form.SERVICE.value == "enable"));
	if (form.SERVICE.value == "enable")
		form.command.value = "/usr/local/emhttp/plugins/controlr/scripts/start";
	else {
		form.command.value = "/usr/local/emhttp/plugins/controlr/scripts/stop";
		form.btnApply.disabled = (form.SERVICE.value == "enable");
	}
}

function verifyDATA(form) {
	if (isNumber(form.PORT.value)){
		if (form.PORT.value < 0 || form.PORT.value > 65535){
			form.PORT.value = "2378";
		}
	} else {
		form.PORT.value = "2378";
	}

	if (isNumber(form.SPORT.value)){
		if (form.SPORT.value < 0 || form.SPORT.value > 65535){
			form.SPORT.value = "2379";
		}
	} else {
		form.SPORT.value = "2379";
	}

	form.SERVICE.value = form.SERVICE.value.replace(/ /g,"_");
	form.PORT.value = form.PORT.value.replace(/ /g,"_");
	form.SPORT.value = form.PORT.value.replace(/ /g,"_");
}

</script>
